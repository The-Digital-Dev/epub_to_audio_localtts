# EPUB to Audiobook Converter Using local Coqui TTS [![Discord](https://img.shields.io/discord/1177631634724491385?label=Discord&logo=discord&logoColor=white)](https://discord.com/invite/pgp2G8zhS7)


This project provides a command-line tool to convert EPUB ebooks into audiobooks using the local TTS service, [Coqui TTS](https://github.com/coqui-ai/TTS). The tool generates the audio for each chapter in the ebook, and the output audio files are optimized for use with [Audiobookshelf](https://github.com/advplyr/audiobookshelf). This project no longer supports cloud-based TTS services like Azure or OpenAI, focusing instead on the privacy and control offered by local TTS.

## Audio Sample

If you're interested in hearing a sample of the audiobook generated by this tool, check the links below. 

- [Coqui TTS Sample](https://audio.com/paudi/audio/0008-chapter-vii-agricultural-experience)

## Requirements

- Python 3.6+ Or ***Docker***
- The following Python packages are required:
```bash
    - `beautifulsoup4==4.12.3`
    - `EbookLib==0.18`
    - `mutagen==1.47.0`
    - `requests==2.32.3`
    - `socksio==1.0.0`
    - `pydub==0.25.1`
    - `TTS==0.22.0`
```
## Audiobookshelf Integration

The audiobooks generated by this project are optimized for use with [Audiobookshelf](https://github.com/advplyr/audiobookshelf). Each chapter in the EPUB file is converted into a separate MP3 file, with the chapter title extracted and included as metadata.

![demo](./examples/audiobookshelf.png)

### Chapter Titles

Parsing and extracting chapter titles from EPUB files can be challenging, as the format and structure may vary significantly between different ebooks. The script employs a simple but effective method for extracting chapter titles, which works for most EPUB files. The method involves parsing the EPUB file and looking for the `title` tag in the HTML content of each chapter. If the title tag is not present, a fallback title is generated using the first few words of the chapter text.

Please note that this approach may not work perfectly for all EPUB files, especially those with complex or unusual formatting. However, in most cases, it provides a reliable way to extract chapter titles for use in Audiobookshelf.

When you import the generated MP3 files into Audiobookshelf, the chapter titles will be displayed, making it easy to navigate between chapters and enhancing your listening experience.

## Installation

1. Clone this repository:

    ```bash
    git clone https://github.com/The-Digital-Dev/epub_to_audio_localtts.git
    cd epub_to_audio_localtts
    ```

2. Create a virtual environment and activate it:

    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

3. Install the required dependencies:

    ```bash
    pip install -r requirements.txt
    ```

4. Download and run the Docker image for local TTS:

    ```bash
    docker pull ghcr.io/the-digital-dev/epub_to_audio_localtts:latest
    ```

## Usage

To convert an EPUB ebook to an audiobook, run the following command:

```bash
docker run --rm -v /path/to/output:/app/output -v /path/to/input:/app/input epub_to_audio_localtts:latest /app/output "/app/input/your_book.epub" --no_prompt
```

To check the latest option descriptions for this script, you can run the following command in the terminal:
```bash
python3 main.py -h
```
```bash
usage: main.py [-h] [--log {DEBUG,INFO,WARNING,ERROR,CRITICAL}] [--preview]
               [--no_prompt] [--language LANGUAGE]
               [--newline_mode {single,double,none}]
               [--title_mode {auto,tag_text,first_few}]
               [--chapter_start CHAPTER_START] [--chapter_end CHAPTER_END]
               [--output_text] [--remove_endnotes] [--voice_name VOICE_NAME]
               [--output_format OUTPUT_FORMAT] [--model_name MODEL_NAME]
               output_folder [input_file]

Convert text book to audiobook

positional arguments:
  output_folder         Path to the output folder
  input_file            Path to the EPUB file (optional)

options:
  -h, --help            show this help message and exit
  --log {DEBUG,INFO,WARNING,ERROR,CRITICAL}
                        Log level (default: INFO), can be DEBUG, INFO,
                        WARNING, ERROR, CRITICAL
  --preview             Enable preview mode. In preview mode, the script will
                        not convert the text to speech. Instead, it will print
                        the chapter index, titles, and character counts.
  --no_prompt           Don't ask the user if they wish to continue after
                        processing. Useful for scripting.
  --language LANGUAGE   Language for the text-to-speech service (default: en-
                        US). This helps in text splitting, especially for
                        Chinese characters.
  --newline_mode {single,double,none}
                        Choose the mode of detecting new paragraphs: 'single',
                        'double', or 'none'. 'single' means a single newline
                        character, while 'double' means two consecutive
                        newline characters. 'none' means all newline
                        characters will be replaced with blanks so paragraphs
                        will not be detected.
  --title_mode {auto,tag_text,first_few}
                        Choose the parse mode for chapter title: 'tag_text'
                        searches 'title','h1','h2','h3' tags for title,
                        'first_few' sets the first 60 characters as title,
                        'auto' automatically applies the best mode for the
                        current chapter.
  --chapter_start CHAPTER_START
                        Chapter start index (default: 1, starting from 1)
  --chapter_end CHAPTER_END
                        Chapter end index (default: -1, meaning to the last
                        chapter)
  --output_text         Enable Output Text. This will export a plain text file
                        for each chapter specified and write the files to the
                        output folder specified.
  --remove_endnotes     This will remove endnote numbers from the end or
                        middle of sentences. This is useful for academic
                        books.
  --voice_name VOICE_NAME
                        Specify the voice name for Coqui TTS.
  --output_format OUTPUT_FORMAT
                        Output format for the text-to-speech service.
                        Supported format depends on Coqui TTS settings.
  --model_name MODEL_NAME
                        Specify the model name for Coqui TTS.
```
**Example**:

```bash
python3 main.py /output /input/The_Life_and_Adventures_of_Robinson_Crusoe.epub --no_prompt
```

Executing the above command will generate a directory named output and save the MP3 files for each chapter inside it using Coqui TTS. Once generated, you can import these audio files into [Audiobookshelf](https://github.com/advplyr/audiobookshelf) or play them with any audio player of your choice.

## Using with Docker

## Using with Docker

This tool is available as a Docker image, making it easy to run without needing to manage Python dependencies.

First, make sure you have Docker installed on your system.

You can pull the Docker image from the GitHub Container Registry:

```bash
docker pull ghcr.io/the-digital-dev/epub_to_audio_localtts:latest
```

Then, you can run the tool with the following command:
```bash
docker run --rm -v ./output:/app/output -v ./input:/app/input epub_to_audio_localtts:latest /app/output "/app/input/filename.epub" --no_prompt
```

The -v /path/to/input:/app/input and -v /path/to/output:/app/output options mount your input and output directories into the Docker container.

## Using Docker Compose
Here is a generic Docker Compose file you can use:

```bash
version: '3'
services:
  epub_to_audiobook:
    image: ghcr.io/the-digital-dev/epub_to_audio_localtts:latest
    environment:
      - TZ=America/Denver
    volumes:
      - ./input:/app/input
      - ./output:/app/output
    command: ["/app/output", "/app/input/your_book.epub", "--no_prompt"]
    restart: unless-stopped
    networks:
      - internal_network

networks:
  internal_network:
    driver: bridge
```

To run the tool with Docker Compose:

```bash
docker-compose up
```
Replace your_book.epub with the name of the input EPUB file.

### FileNotFoundError: [Errno 2] No such file or directory: 'ffmpeg'

Make sure ffmpeg binary is accessible from your path. If you are on a mac and use homebrew, you can do `brew install ffmpeg`, On Ubuntu you can do `sudo apt install ffmpeg`